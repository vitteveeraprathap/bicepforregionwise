name: Bicep Deployment

on:
  workflow_call:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: string
      bicep_file:
        description: 'Path to Bicep template file'
        required: true
        type: string
      parameters_file:
        description: 'Path to parameters file'
        required: true
        type: string
      deployment_scope:
        description: 'Deployment scope (group or sub)'
        required: true
        type: string
      deployment_location:
        description: 'Location for subscription deployments'
        required: false
        type: string
        default: 'westus2'
      output_query:
        description: 'JMESPath query for deployment output (leave empty for no output)'
        required: false
        type: string
        default: ''
    outputs:
      deployment_output:
        description: 'Output from the deployment'
        value: ${{ jobs.deploy.outputs.deployment_output }}
    secrets:
      azure_credentials:
        description: 'Azure service principal credentials'
        required: true
      resource_group_name:
        description: 'Resource group name (required for group scope)'
        required: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      deployment_output: ${{ steps.set-output.outputs.result }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.azure_credentials }}
      
      - name: Validate deployment scope
        run: |
          SCOPE="${{ inputs.deployment_scope }}"
          if [[ "$SCOPE" != "group" && "$SCOPE" != "sub" ]]; then
            echo "Invalid deployment scope: $SCOPE"
            echo "Valid values are: 'group' or 'sub'"
            exit 1
          fi
          echo "Deployment scope validated: $SCOPE"
      
      - name: Validate resource group for group scope
        if: inputs.deployment_scope == 'group'
        run: |
          RG_NAME="${{ secrets.resource_group_name }}"
          if [ -z "$RG_NAME" ]; then
            echo "Resource group name is required for group scope deployments"
            exit 1
          fi
          echo "Resource group validated: $RG_NAME"
      
      - name: Deploy (Group Scope)
        if: inputs.deployment_scope == 'group'
        id: deploy-group
        run: |
          echo "::group::Deploying to Resource Group"
          if [ -n "${{ inputs.output_query }}" ]; then
            DEPLOYMENT_OUTPUT=$(az deployment group create \
              --resource-group "${{ secrets.resource_group_name }}" \
              --template-file ${{ inputs.bicep_file }} \
              --parameters @"${{ inputs.parameters_file }}" \
              --query '${{ inputs.output_query }}' \
              --output tsv \
              --verbose)
            echo "result=$DEPLOYMENT_OUTPUT" >> "$GITHUB_OUTPUT"
            echo "Deployment output: $DEPLOYMENT_OUTPUT"
          else
            az deployment group create \
              --resource-group "${{ secrets.resource_group_name }}" \
              --template-file ${{ inputs.bicep_file }} \
              --parameters @"${{ inputs.parameters_file }}" \
              --verbose
            echo "result=" >> "$GITHUB_OUTPUT"
            echo "Deployment completed (no output query specified)"
          fi
          echo "::endgroup::"
      
      - name: Deploy (Subscription Scope)
        if: inputs.deployment_scope == 'sub'
        id: deploy-sub
        run: |
          echo "::group::Deploying to Subscription"
          if [ -n "${{ inputs.output_query }}" ]; then
            DEPLOYMENT_OUTPUT=$(az deployment sub create \
              --location ${{ inputs.deployment_location }} \
              --template-file ${{ inputs.bicep_file }} \
              --parameters @"${{ inputs.parameters_file }}" \
              --query '${{ inputs.output_query }}' \
              --output tsv \
              --verbose)
            echo "result=$DEPLOYMENT_OUTPUT" >> "$GITHUB_OUTPUT"
            echo "Deployment output: $DEPLOYMENT_OUTPUT"
          else
            az deployment sub create \
              --location ${{ inputs.deployment_location }} \
              --template-file ${{ inputs.bicep_file }} \
              --parameters @"${{ inputs.parameters_file }}" \
              --verbose
            echo "result=" >> "$GITHUB_OUTPUT"
            echo "Deployment completed (no output query specified)"
          fi
          echo "::endgroup::"
      
      - name: Set deployment output
        id: set-output
        run: |
          if [ "${{ inputs.deployment_scope }}" == "group" ]; then
            echo "result=${{ steps.deploy-group.outputs.result }}" >> "$GITHUB_OUTPUT"
          else
            echo "result=${{ steps.deploy-sub.outputs.result }}" >> "$GITHUB_OUTPUT"
          fi
      
      - name: Post Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.azure_credentials }}
      
      - name: Deployment Summary
        run: |
          echo "::group::Deployment Summary"
          echo "=========================================="
          echo "Environment: ${{ inputs.environment }}"
          echo "Scope: ${{ inputs.deployment_scope }}"
          echo "Bicep File: ${{ inputs.bicep_file }}"
          echo "Parameters: ${{ inputs.parameters_file }}"
          if [ "${{ inputs.deployment_scope }}" == "group" ]; then
            echo "Resource Group: ${{ secrets.resource_group_name }}"
          else
            echo "Location: ${{ inputs.deployment_location }}"
          fi
          if [ -n "${{ steps.set-output.outputs.result }}" ]; then
            echo "Output: ${{ steps.set-output.outputs.result }}"
          fi
          echo "=========================================="
          echo "Deployment completed successfully"
          echo "::endgroup::"
